<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Pedidos - Magic Travel</title>

  <!-- ========== CSS do PlainAdmin / Bootstrap / etc. ========== -->
  <link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon" />
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/lineicons.css" />
  <link rel="stylesheet" href="assets/css/quill/bubble.css" />
  <link rel="stylesheet" href="assets/css/quill/snow.css" />
  <link rel="stylesheet" href="assets/css/fullcalendar.css" />
  <link rel="stylesheet" href="assets/css/morris.css" />
  <link rel="stylesheet" href="assets/css/datatable.css" />
  <link rel="stylesheet" href="assets/css/main.css" />

  <!-- Se quiser ícones do Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">

  <style>
    /* ============= Ajustes adicionais de estilo ============= */
    /* Tabela "Financeiro | Pedidos" */
    .finance-table thead th {
      background-color: #f5f6fa;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      position: relative; /* p/ setas */
    }
    .finance-table tbody tr:nth-child(even) {
      background-color: #f9fafc;
    }
    .finance-table tbody tr:hover {
      background-color: #eef4ff;
      cursor: pointer;
    }
    .sort-indicator {
      margin-left: 6px;
      font-size: 0.75rem;
      opacity: 0.7;
    }
    .sort-indicator.asc::before {
      content: "\\2191"; /* seta para cima */
    }
    .sort-indicator.desc::before {
      content: "\\2193"; /* seta para baixo */
    }
    /* Botões de paginação */
    .pagination-finance {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin-top: 20px;
    }
    .pagination-finance button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      background: #4a6cf7;
      color: #fff;
      cursor: pointer;
    }
    .pagination-finance button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    /* Caso queira usar as classes do PlainAdmin para status 
       (exemplo: success-btn, danger-btn, warning-btn, etc.)
       Aqui iremos criar uma conversão no JS. */
  </style>
</head>

<body>
  <!-- ======== Preloader =========== -->
  <div id="preloader">
    <div class="spinner"></div>
  </div>
  <!-- ======== Preloader =========== -->

  <!-- ======== sidebar-nav start =========== -->
  <aside class="sidebar-nav-wrapper">
    <div class="navbar-logo">
      <a href="index.html">
        <img src="assets/images/logo/logo.svg" alt="logo" />
      </a>
    </div>
    <nav class="sidebar-nav">
      <!-- Conteúdo original do tema PlainAdmin (links do menu) -->
      <ul>
        <li class="nav-item nav-item-has-children">
          <a href="#0" data-bs-toggle="collapse" data-bs-target="#ddmenu_1" aria-controls="ddmenu_1"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="icon">
              <!-- Exemplo de ícone -->
              <svg width="20" height="20" ...> ... </svg>
            </span>
            <span class="text">Dashboard</span>
          </a>
          <ul id="ddmenu_1" class="collapse show dropdown-nav">
            <li><a href="index.html"> eCommerce </a></li>
            <li><a href="analytics-dashboard.html"> Analytics </a></li>
            <li><a href="crypto.html" class="active"> Crypto </a></li>
            <!-- etc. -->
          </ul>
        </li>
        <!-- ... demais menus ... -->
      </ul>
    </nav>
    <div class="promo-box">
      <div class="promo-icon">
        <img class="mx-auto" src="assets/images/logo/logo-icon-big.svg" alt="Logo">
      </div>
      <h3>Upgrade to PRO</h3>
      <p>Improve your development process and start doing more with PlainAdmin PRO!</p>
      <a href="https://plainadmin.com/pro" target="_blank" rel="nofollow" class="main-btn primary-btn btn-hover">
        Upgrade to PRO
      </a>
    </div>
  </aside>
  <div class="overlay"></div>
  <!-- ======== sidebar-nav end =========== -->

  <!-- ======== main-wrapper start =========== -->
  <main class="main-wrapper">
    <!-- ========== header start ========== -->
    <header class="header">
      <div class="container-fluid">
        <!-- Conteúdo padrão do cabeçalho (logo, busca, perfil, etc.) -->
        <div class="row">
          <div class="col-lg-5 col-md-5 col-6">
            <div class="header-left d-flex align-items-center">
              <div class="menu-toggle-btn mr-15">
                <button id="menu-toggle" class="main-btn primary-btn btn-hover">
                  <i class="lni lni-chevron-left me-2"></i> Menu
                </button>
              </div>
              <div class="header-search d-none d-md-flex">
                <form action="#">
                  <input type="text" placeholder="Search..." />
                  <button><i class="lni lni-search-alt"></i></button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-7 col-md-7 col-6">
            <div class="header-right">
              <!-- Notificações, Mensagens, Perfil etc... (padrão do template) -->
              <!-- ... -->
            </div>
          </div>
        </div>
      </div>
    </header>
    <!-- ========== header end ========== -->

    <!-- ========== section start ========== -->
    <section class="section">
      <div class="container-fluid">
        <!-- ========== title-wrapper start ========== -->
        <div class="title-wrapper pt-30">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="title">
                <h2>Pedidos a pagar</h2>
              </div>
            </div>
            <div class="col-md-6">
              <div class="breadcrumb-wrapper">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#0">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Crypto</li>
                  </ol>
                </nav>
              </div>
            </div>
          </div>
        </div>
        <!-- ========== title-wrapper end ========== -->

        <!-- ======================================
             (1) Primeiro Bloco: 3 single-cards 
             usando cores e textos solicitados
        ====================================== -->
        <div class="row">
          <div class="col-lg-12">
            <div class="card-style card-wrapper mb-30">
              <!-- 1) Total a Pagar (U$) [rgb(54, 92, 245)] -->
              <div class="single-card-wrapper">
                <div class="single-card" style="background-color: rgb(54, 92, 245);">
                  <span class="text-sm text-white fw-500">Total a Pagar (U$)</span>
                  <h3 id="cardTotalUsd" style="color: #fff;">$0.00</h3>
                  <!-- Espaço se quiser subtítulo/comparativo -->
                  <div class="card-info">
                    <div class="mr-15">
                      <span style="color:#fff;">Comparativo</span>
                      <p id="comparativoUsd" style="color:#fff;">...</p>
                    </div>
                  </div>
                </div>
              </div>
              <!-- 2) Total de Itens [rgb(52, 93, 157)] -->
              <div class="single-card-wrapper">
                <div class="single-card" style="background-color: rgb(52, 93, 157);">
                  <span class="text-sm text-white fw-500">Total de Itens</span>
                  <h3 id="cardTotalItens" style="color: #fff;">0</h3>
                  <div class="card-info">
                    <div class="mr-15">
                      <span style="color:#fff;">Comparativo</span>
                      <p id="comparativoItens" style="color:#fff;">...</p>
                    </div>
                  </div>
                </div>
              </div>
              <!-- 3) Valor a Pagar (R$) [#219653] -->
              <div class="single-card-wrapper">
                <div class="single-card" style="background-color: #219653;">
                  <span class="text-sm text-white fw-500">Valor a Pagar (R$)</span>
                  <h3 id="cardTotalReais" style="color: #fff;">R$ 5.57</h3>
                  <div class="card-info">
                    <div class="mr-15">
                      <span style="color:#fff;">Cotação Exemplo</span>
                      <p style="color:#fff;">(Editável JS)</p>
                    </div>
                    <!-- Se quiser input manual, pode replicar do old code -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- row -->

        <!-- ======================================
             (2) Segundo Bloco: Financeiro | Pedidos 
             substituindo "Recent Activities"
        ====================================== -->
        <div class="row">
          <div class="col-lg-12 col-xl-12 col-xxl-12">
            <div class="card-style mb-30">
              <!-- Cabeçalho do Card -->
              <div class="title d-flex flex-wrap align-items-center justify-content-between mb-10">
                <div class="left mb-2">
                  <h6 class="text-medium mb-2">Financeiro | Pedidos</h6>
                  <p class="text-gray text-sm">Tabela unindo código antigo + layout novo</p>
                </div>
                <div class="right mb-2">
                  <button class="main-btn primary-btn btn-hover" onclick="addNewOrder()">Adicionar Pedido</button>
                </div>
              </div>
              <!-- Tabela -->
              <div class="table-responsive">
                <table class="table finance-table">
                  <thead>
                    <tr>
                      <th data-sort-key="nome">Nome <span class="sort-indicator"></span></th>
                      <th data-sort-key="id_pedido">ID do Pedido <span class="sort-indicator"></span></th>
                      <th data-sort-key="produto">Itens <span class="sort-indicator"></span></th>
                      <th data-sort-key="valor_calculado">Valor (U$) <span class="sort-indicator"></span></th>
                      <th data-sort-key="data_uso">Data de Uso <span class="sort-indicator"></span></th>
                      <th data-sort-key="data_pagamento">Data de Pagamento <span class="sort-indicator"></span></th>
                      <th data-sort-key="identificador">Identificador <span class="sort-indicator"></span></th>
                      <th data-sort-key="fornecedor">Fornecedor <span class="sort-indicator"></span></th>
                      <th data-sort-key="status">Status <span class="sort-indicator"></span></th>
                      <th style="width:50px; text-align:center;">Ação</th>
                    </tr>
                  </thead>
                  <tbody id="orders-table">
                    <!-- Preenchido via JS -->
                  </tbody>
                </table>
              </div>
              <!-- Paginação -->
              <div class="pagination-finance" id="pagination-controls"></div>
            </div>
          </div>
        </div><!-- row -->

        <!-- ======================================
             (3) Terceiro Bloco: "Sell Order" -> "Próximos Pagamentos"
        ====================================== -->
        <div class="row">
          <div class="col-md-6 col-lg-3 col-xl-6 col-xxl-3">
            <div class="card-style mb-30">
              <div class="title d-flex flex-wrap align-items-center justify-content-between mb-10">
                <div class="left">
                  <h6 class="text-medium mb-2">Próximos Pagamentos</h6>
                </div>
                <div class="right mb-2">
                  <div class="more-btn-wrapper mb-10">
                    <button class="more-btn dropdown-toggle" id="moreAction" data-bs-toggle="dropdown"
                      aria-expanded="false">
                      <i class="lni lni-more-alt"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="moreAction">
                      <li class="dropdown-item"><a href="#0" class="text-gray">Opção 1</a></li>
                      <li class="dropdown-item"><a href="#0" class="text-gray">Opção 2</a></li>
                    </ul>
                  </div>
                </div>
              </div>
              <!-- Tabela Data / Dólar / Reais -->
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Dólar</th>
                      <th class="text-end">Reais</th>
                    </tr>
                  </thead>
                  <tbody id="proximos-body">
                    <!-- Preenchido dinamicamente em fillProximosDias() -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div><!-- row -->

      </div> <!-- end container -->
    </section>
    <!-- ========== section end ========== -->

    <!-- ========== footer start =========== -->
    <footer class="footer">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-6 order-last order-md-first">
            <div class="copyright text-center text-md-start">
              <p class="text-sm">
                Designed and Developed by
                <a href="https://plainadmin.com" rel="nofollow" target="_blank">PlainAdmin</a>
              </p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="terms d-flex justify-content-center justify-content-md-end">
              <a href="#0" class="text-sm">Term &amp; Conditions</a>
              <a href="#0" class="text-sm ml-15">Privacy &amp; Policy</a>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- ========== footer end ========== -->
  </main>
  <!-- ======== main-wrapper end =========== -->

  <!-- ============ Theme Option (padrão do PlainAdmin) ============= -->
  <button class="option-btn">
    <i class="lni lni-cog"></i>
  </button>
  <div class="option-overlay"></div>
  <div class="option-box">
    <div class="option-header">
      <h5>Settings</h5>
      <button class="option-btn-close text-gray"><i class="lni lni-close"></i></button>
    </div>
    <h6 class="mb-10">Layout</h6>
    <ul class="mb-30">
      <li><button class="leftSidebarButton active">Left Sidebar</button></li>
      <li><button class="rightSidebarButton">Right Sidebar</button></li>
    </ul>
    <h6 class="mb-10">Theme</h6>
    <ul class="d-flex flex-wrap align-items-center">
      <li><button class="lightThemeButton active">Light Theme + Sidebar 1</button></li>
      <li><button class="darkThemeButton">Dark Theme + Sidebar 1</button></li>
    </ul>
    <div class="promo-box">
      <div class="promo-icon">
        <img class="mx-auto" src="assets/images/logo/logo-icon-big.svg" alt="Logo">
      </div>
      <h3>Upgrade to PRO</h3>
      <p>Improve your development process and start doing more with PlainAdmin PRO!</p>
      <a href="https://plainadmin.com/pro" target="_blank" rel="nofollow" class="main-btn primary-btn btn-hover">
        Upgrade to PRO
      </a>
    </div>
  </div>
  <!-- ============ Theme Option End ============= -->

  <!-- ========= Scripts do Template (Bootstrap, Chart, etc.) ======== -->
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/Chart.min.js"></script>
  <script src="assets/js/apexcharts.min.js"></script>
  <script src="assets/js/dynamic-pie-chart.js"></script>
  <script src="assets/js/moment.min.js"></script>
  <script src="assets/js/fullcalendar.js"></script>
  <script src="assets/js/jvectormap.min.js"></script>
  <script src="assets/js/world-merc.js"></script>
  <script src="assets/js/polyfill.js"></script>
  <script src="assets/js/quill.min.js"></script>
  <script src="assets/js/datatable.js"></script>
  <script src="assets/js/Sortable.min.js"></script>
  <script src="assets/js/main.js"></script>

  <!-- ========== Nosso JavaScript Unindo Lógicas do Código Antigo + Novo ========== -->
  <script>
    /* -------------------------------
       Variáveis Globais (ex do código antigo)
    --------------------------------*/
    let combinedOrders = [];     // Receberá dados das APIs
    let displayedOrders = [];    // Subconjunto filtrado
    let currentPage = 1;
    const rowsPerPage = 10;
    const sortDirections = {};

    // Exemplo de datas para filtrar (se desejar)
    let selectedStartDate = null;
    let selectedEndDate = null;

    // Exemplo de cotações do código antigo
    const ultimaCotacaoFechamento   = 5.79;
    const penultimaCotacaoFechamento= 5.75;
    // + 0.98% spread
    let cotacaoEmUso     = parseFloat((ultimaCotacaoFechamento * (1 + 0.0098)).toFixed(2));
    let cotacaoPenultima = parseFloat((penultimaCotacaoFechamento * (1 + 0.0098)).toFixed(2));

    /* -------------------------------
       1) Funções p/ Financeiro | Pedidos
    --------------------------------*/
    function addNewOrder() {
      alert("Ir para Adicionar Pedido? Exemplo...");
      // ou window.location.href = "https://business.magictraveltur.com/loti.html";
    }
    function openDetailsPage(orderId) {
      alert("Abrir detalhes do pedido " + orderId + " (exemplo).");
      // ou window.open(`detalhes.html?pedido=${orderId}`, '_blank');
    }
    function normalizeStatus(st) {
      if (!st) return "";
      return st.toLowerCase().trim();
    }
    // Exemplo: converter status p/ classes de btn do PlainAdmin
    function getStatusClass(st) {
      switch(st) {
        case "concluído":          return "success-btn";
        case "aguardando emissão": return "danger-btn"; // ou outro
        case "emitido tif":        return "warning-btn";
        case "emissão bloqueada":  return "dark-btn";
        case "emitido – não pago": return "active-btn";
        default: return "secondary-btn";
      }
    }
    function formatDate(str){
      if(!str) return "";
      const [yyyy,mm,dd] = str.split("-").map(Number);
      return `${String(dd).padStart(2,"0")}/${String(mm).padStart(2,"0")}/${yyyy}`;
    }
    function renderTable(data) {
      const tbody = document.getElementById("orders-table");
      // Paginação
      const start = (currentPage - 1)*rowsPerPage;
      const end = start + rowsPerPage;
      const slice = data.slice(start,end);

      let html = "";
      slice.forEach(o => {
        const stNorm = normalizeStatus(o.status);
        const stClass = getStatusClass(stNorm);
        // Exemplo: botões do PlainAdmin = <a class="main-btn success-btn">
        // Ajustamos o label do status
        const statusHtml = `<a class="main-btn ${stClass} btn-hover" style="padding:4px 10px; font-size:12px;">
          ${o.status || 'Sem Status'}</a>`;

        html += `
          <tr>
            <td>${o.nome}</td>
            <td>${o.id_pedido}</td>
            <td>${o.produto}</td>
            <td>U$ ${o.valor_calculado}</td>
            <td>${formatDate(o.data_uso)}</td>
            <td>${formatDate(o.data_pagamento)}</td>
            <td>${o.identificador}</td>
            <td>${o.fornecedor}</td>
            <td>${statusHtml}</td>
            <td style="width:50px; text-align:center;">
              <i class="bi bi-eye" style="cursor:pointer;" 
                 onclick="openDetailsPage('${o.id_pedido}')"></i>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }
    function renderPagination(data) {
      const pagination = document.getElementById("pagination-controls");
      pagination.innerHTML = "";
      const totalPages = Math.ceil(data.length/rowsPerPage);
      for (let i=1; i<= totalPages; i++){
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.disabled = (i=== currentPage);
        btn.onclick = ()=> {
          currentPage = i;
          renderTable(displayedOrders);
          renderPagination(displayedOrders);
        };
        pagination.appendChild(btn);
      }
    }
    function compareValues(a,b,key,dir){
      let valA = a[key], valB = b[key];
      // Se for data
      if(key==="data_uso"||key==="data_pagamento"){
        if(!valA) valA="0000-00-00";
        if(!valB) valB="0000-00-00";
        valA = new Date(valA).getTime();
        valB = new Date(valB).getTime();
      }
      else if(key==="valor_calculado"){
        valA = parseFloat(valA)||0;
        valB = parseFloat(valB)||0;
      } else {
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
      }
      if(valA<valB) return (dir==="asc")? -1:1;
      if(valA>valB) return (dir==="asc")? 1:-1;
      return 0;
    }
    function sortColumn(key) {
      const currentDir = sortDirections[key] || null;
      let newDir = "asc";
      if(currentDir==="asc") newDir="desc";
      else if(currentDir==="desc") newDir="asc";
      // reset
      for (let k in sortDirections) sortDirections[k]= null;
      sortDirections[key]= newDir;
      displayedOrders.sort((a,b)=>compareValues(a,b,key,newDir));
      updateSortIndicators(key,newDir);
      currentPage =1;
      renderTable(displayedOrders);
      renderPagination(displayedOrders);
    }
    function updateSortIndicators(activeKey,direction) {
      const ths = document.querySelectorAll('.finance-table thead th');
      ths.forEach(th => {
        const span = th.querySelector('.sort-indicator');
        if(span) span.classList.remove("asc","desc");
      });
      const activeTh = document.querySelector(`th[data-sort-key="${activeKey}"]`);
      if(activeTh){
        const sp = activeTh.querySelector('.sort-indicator');
        if(sp){
          if(direction==="asc") sp.classList.add("asc");
          if(direction==="desc")sp.classList.add("desc");
        }
      }
    }
    function initSortingEvents(){
      const ths = document.querySelectorAll('.finance-table thead th');
      ths.forEach(th=>{
        const sortKey = th.getAttribute('data-sort-key');
        if(sortKey){
          th.addEventListener('click', ()=> sortColumn(sortKey));
        }
      });
    }

    /* -------------------------------
       2) Calcular Totais e Comparativos
          (exemplo do old code)
    --------------------------------*/
    function calcPercentChange(newVal, oldVal){
      if(oldVal===0){
        if(newVal===0) return 0;
        return 100;
      }
      return ((newVal - oldVal)/ oldVal)*100;
    }
    function calculateIntervalData(orders){
      // Exemplo: soma do valor_calculado se status = emitido – não pago, etc...
      // (Você pode customizar conforme a lógica do antigo)
      let totalUsd=0;
      let pedidosSet= new Set();
      orders.forEach(o=>{
        const st = normalizeStatus(o.status);
        if(["emitido – não pago","emitido tif","emissão bloqueada"].includes(st)){
          const v= parseFloat(o.valor_calculado)||0;
          totalUsd+= v;
        }
        pedidosSet.add(o.id_pedido);
      });
      return {
        totalUsd,
        totalPedidos: pedidosSet.size
      };
    }
    function atualizarResumo() {
      const dataCalc = calculateIntervalData(displayedOrders);
      const totalUsd= dataCalc.totalUsd;
      const totPedidos= dataCalc.totalPedidos;
      // Mostramos nos cartões
      document.getElementById("cardTotalUsd").textContent = `U$ ${totalUsd.toFixed(2)}`;
      // Exemplo comparativo
      const oldValue=100; // Fictício
      const pct= calcPercentChange(totalUsd, oldValue);
      document.getElementById("comparativoUsd").textContent=
        (pct>=0)? `+${pct.toFixed(1)}% vs ant.` : `${pct.toFixed(1)}% vs ant.`;

      document.getElementById("cardTotalItens").textContent= `${totPedidos}`;
      // Idem comparativo
      document.getElementById("comparativoItens").textContent= `...`;

      // Em Reais
      // Pegamos do 3º cartão (Valor a Pagar (R$)), ex: "R$ 5.57"
      let exchange=5.57;
      const txt = document.getElementById("cardTotalReais").textContent;
      const match= txt.match(/([\d.,]+)/);
      if(match) {
        exchange= parseFloat(match[1].replace(",","."))||5.57;
      }
      const totReais= totalUsd * exchange;
      // Se quiser atualizar o 3º card:
      document.getElementById("cardTotalReais").textContent= `R$ ${exchange.toFixed(2)}`;
    }

    /* -------------------------------
       3) Carregar as APIs (old code)
    --------------------------------*/
    async function loadOrders(){
      try {
        // Se quiser filtrar por data (selectedStartDate, selectedEndDate), ex:
        const startDate= selectedStartDate ? selectedStartDate.toISOString().split('T')[0] : "";
        const endDate= selectedEndDate ? selectedEndDate.toISOString().split('T')[0] : "";

        // Ajuste as URLs:
        const apiUrlPlanilhas = `https://www.magictraveltur.com/api_planilhas.php?start_date=${startDate}&end_date=${endDate}`;
        const apiUrlPedidos   = `https://www.magictraveltur.com/api_pedidos.php`;

        // fetch duplo
        const [respPlanilhas, respPedidos] = await Promise.all([
          fetch(apiUrlPlanilhas, {credentials:'include'}),
          fetch(apiUrlPedidos,   {credentials:'include'}),
        ]);
        if(!respPlanilhas.ok) throw new Error(`Erro planilhas: ${respPlanilhas.status}`);
        if(!respPedidos.ok)   throw new Error(`Erro pedidos: ${respPedidos.status}`);

        const planilhasData = await respPlanilhas.json();
        const pedidosData   = await respPedidos.json();
        if(!Array.isArray(planilhasData) || !Array.isArray(pedidosData)){
          console.error("Erro de dados, arrays esperados");
          return;
        }
        // Mapeamos pedidos id -> nome
        const pedidosMap = {};
        pedidosData.forEach(p => { pedidosMap[p.id] = p.nome; });

        // Montamos combinedOrders
        combinedOrders= planilhasData.map(pl=>{
          const totalUsd= parseFloat(pl.total_usd)||0;
          const lobista= parseFloat(pl.lobista)||0;
          const valorCalc= (totalUsd - lobista).toFixed(2);
          return {
            nome: (pedidosMap[pl.id_pedido]||"N/A"),
            id_pedido: pl.id_pedido,
            produto: pl.produto||"",
            valor_calculado: valorCalc,
            data_uso: pl.data||"",
            data_pagamento: pl.data_pagamento||"",
            identificador: pl.identificador||"",
            fornecedor: pl.fornecedor||"",
            status: pl.status||"",
          };
        });
        // Por padrão exibimos todos
        displayedOrders= combinedOrders.slice();
        // Renderizamos
        currentPage=1;
        renderTable(displayedOrders);
        renderPagination(displayedOrders);
        atualizarResumo();

      } catch(err){
        console.error("Erro ao carregar APIs:", err);
        document.getElementById("orders-table").innerHTML=`
        <tr><td colspan="10" style="color:red;">Erro ao carregar pedidos</td></tr>`;
      }
    }

    /* -------------------------------
       4) Terceiro bloco: fillProximosDias
    --------------------------------*/
    function fillProximosDias(){
      const tBody= document.getElementById("proximos-body");
      tBody.innerHTML="";
      const hoje= new Date();

      // Lemos a suposta "cotação" do 3º card
      let exchange=5.57;
      const txt = document.getElementById("cardTotalReais").textContent;
      const match= txt.match(/([\d.,]+)/);
      if(match){
        exchange= parseFloat(match[1].replace(",","."))||5.57;
      }

      let baseUsd=100; // Exemplo: cada dia incrementamos baseUsd*i

      for(let i=1; i<=5; i++){
        const prox = new Date(hoje.getFullYear(),hoje.getMonth(),hoje.getDate()+i);
        const d= String(prox.getDate()).padStart(2,"0");
        const m= String(prox.getMonth()+1).padStart(2,"0");
        const y= prox.getFullYear();

        const usd= baseUsd*i; 
        const brl= (usd*exchange).toFixed(2);

        const row= `
          <tr>
            <td>${d}/${m}/${y}</td>
            <td>U$ ${usd.toFixed(2)}</td>
            <td class="text-end">R$ ${brl}</td>
          </tr>
        `;
        tBody.insertAdjacentHTML("beforeend",row);
      }
    }

    /* -------------------------------
       Inicialização
    --------------------------------*/
    document.addEventListener("DOMContentLoaded", ()=>{
      initSortingEvents();
      fillProximosDias(); // Gera as linhas de "Próximos Pagamentos"
      loadOrders();       // Chama as APIs e renderiza a tabela
      // Se tivesse sidebar: loadSidebar() ...
    });
  </script>

  <!-- Scripts de Charts do Template (SEM alterações) -->
  <script>
    /* Exemplo de scripts de chart1, chart2, chart3, chart4 do PlainAdmin.
       Coloquei um “...” para não poluir mais. 
       Se quiser, mantenha-os. 
    */
  </script>
</body>
</html>
